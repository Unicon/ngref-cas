# The Proxy
proxy:
  image: docker.dev.ccctechcenter.org/idp-proxy:1.3.0-SNAPSHOT
  container_name: proxy
  ports:
    - 8081:80
  links:
      - httpd:httpd
  environment:
      - VIRTUAL_HOST=sso.local.cccmypath.org
  volumes:
    - $PWD/external-config/local/opt/ccc/config/config.php:/var/simplesamlphp/config/config.php
    - $PWD/external-config/local/opt/ccc/config/authsources.php:/var/simplesamlphp/config/authsources.php
    - $PWD/external-config/local/opt/ccc/config/authccc.php:/var/simplesamlphp/config/authccc.php
    - $PWD/external-config/local/opt/ccc/config/module_cron.php:/var/simplesamlphp/config/module_cron.php
    - $PWD/external-config/local/opt/ccc/config/config-metarefresh.php:/var/simplesamlphp/config/config-metarefresh.php
    - $PWD/external-config/local/opt/ccc/config/initial-metarefresh.sh:/var/simplesamlphp/config/initial-metarefresh.sh
    - $PWD/external-config/local/opt/ccc/config/credentials:/var/simplesamlphp/credentials
    - $PWD/overlay/var/simplesamlphp/templates/status.php:/var/simplesamlphp/templates/status.php
    #- $PWD/overlay/var/simplesamlphp/templates/includes/attributes.php:/var/simplesamlphp/templates/includes/attributes.php
    #- ~/opt/ccc/config/simplesaml/metadata:/var/simplesamlphp/metadata
    #- /Users/pneff/IdeaProjects/idp-proxy/external-config/local/metadata:/var/simplesamlphp/metadata

idp:
  image: docker.dev.ccctechcenter.org/idp-college:3.2.1-SNAPSHOT
  ports:
    - 8443:8443
  environment:
    - IDP_HOST=https://localhost:8443
    - IDP_METADATA_URL=http://httpd/local-metadata.xml
  links:
    - collegeldap:collegeldap
    - httpd:httpd

collegeldap:
    image: docker.dev.ccctechcenter.org/openldap-college:1.2.0-SNAPSHOT
    environment:
      - ENV=ci

httpd:
  image: httpd:2.4
  ports:
    - 80:80
  volumes:
    - $PWD/external-config/local/htdocs/:/usr/local/apache2/htdocs

nginx-proxy:
    image: jwilder/nginx-proxy
    ports:
      - 443:443
    volumes:
      - /var/run/docker.sock:/tmp/docker.sock:ro
      - $PWD/external-config/local/certs:/etc/nginx/certs

test-sp:
  image: test-sp
  container_name: test-sp
  ports:
    - 8080:8080
  environment:
      - VIRTUAL_HOST=sp.local.cccmypath.org
      - entity.id=https://sp.local.cccmypath.org/saml-demo/saml2
      - url.proxy=https://sso.local.cccmypath.org/simplesaml/saml2/idp/SSOService.php?source=local_mock&spentityid=https://sp.local.cccmypath.org/saml-demo/saml2&RelayState=https://sp.local.cccmypath.org/saml-demo/demo/

